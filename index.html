<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>QR-kod på mallbild (6 per A4)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPDF från CDN -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    defer
  ></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f3f4f6;
      color: #111827;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    h1 {
      margin-top: 0;
      font-size: 1.7rem;
      text-align: center;
    }
    .field-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    input[type="file"] {
      margin-top: 0.25rem;
    }
    .help {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }
    .two-cols {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }
    @media (max-width: 700px) {
      .two-cols {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
    button {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37,99,235,0.35);
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(37,99,235,0.45);
      background: #1d4ed8;
    }
    .status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      min-height: 1.2rem;
    }
    .status--ok {
      color: #065f46;
    }
    .status--error {
      color: #b91c1c;
    }
    .status--info {
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>QR-kod på mallbild (6 per A4)</h1>

    <div class="field-group">
      <label for="templateFile">Mallbild - rekommenderad storlek är 800 X 765 </label>
      <input id="templateFile" type="file" accept="image/*" />
      <div class="help">
        Detta är den färdiga designen (t.ex. PNG). QR-koden läggs ovanpå denna bild på samma ställe för alla.
      </div>
    </div>

    <div class="field-group">
      <label for="qrFiles">QR-koder (PNG/JPG, flera filer)</label>
      <input id="qrFiles" type="file" accept="image/png,image/jpeg" multiple />
      <div class="help">
        Välj alla QR-kodbilder upp till 1000 st. Varje mallbild får en unik QR-kod.
      </div>
    </div>

    <div class="field-group">
      <label>QR-position och storlek (mm på mallbilden, mitten är 35mm)</label>
      <div class="two-cols">
        <div>
          <label for="qrOffsetX">QR X-position (mm)</label>
          <input id="qrOffsetX" type="number" step="0.5" value="10" />
          <div class="help">Avstånd från mallbildens vänstra kant (35mm är mitten ca).</div>
        </div>
        <div>
          <label for="qrOffsetY">QR Y-position (mm)</label>
          <input id="qrOffsetY" type="number" step="0.5" value="10" />
          <div class="help">Avstånd från mallbildens övre kant.</div>
        </div>
        <div>
          <label for="qrSize">QR storlek (mm)</label>
          <input id="qrSize" type="number" step="0.5" value="25" />
          <div class="help">Bredd och höjd (kvadrat).</div>
        </div>
      </div>
      <div class="help">
        Du kan justera med testutskrifter tills det sitter perfekt.
      </div>
    </div>

    <div class="field-group">
      <button id="generateBtn">Generera PDF</button>
      <div class="status status--info" id="statusText"></div>
    </div>

    <div class="help">
      Layout: A4 stående, 2 kolumner × 3 rader (6 per sida).<br />
      Varje layout = mallbild + en unik QR-kod på samma position.
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const templateInput = document.getElementById("templateFile");
      const qrInput = document.getElementById("qrFiles");
      const qrOffsetXInput = document.getElementById("qrOffsetX");
      const qrOffsetYInput = document.getElementById("qrOffsetY");
      const qrSizeInput = document.getElementById("qrSize");
      const generateBtn = document.getElementById("generateBtn");
      const statusText = document.getElementById("statusText");

      function setStatus(message, type = "info") {
        statusText.textContent = message || "";
        statusText.className = "status status--" + type;
        console.log("STATUS:", message);
      }

      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = err => reject(err);
          reader.readAsDataURL(file);
        });
      }

      function getImageSize(dataUrl) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            resolve({ width: img.naturalWidth, height: img.naturalHeight });
          };
          img.onerror = (err) => reject(err);
          img.src = dataUrl;
        });
      }

      async function loadQrImages(fileList) {
        const files = Array.from(fileList || []);
        const result = [];
        for (const file of files) {
          if (!file.type.startsWith("image/")) continue;
          const dataUrl = await readFileAsDataURL(file);
          result.push({ name: file.name, dataUrl });
        }
        return result;
      }

      async function generatePdf() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          setStatus("jsPDF kunde inte laddas. Kontrollera internetanslutningen.", "error");
          alert("Fel: jsPDF-biblioteket laddades inte. Prova att ladda om sidan.");
          return;
        }

        if (!templateInput.files || templateInput.files.length === 0) {
          setStatus("Du måste välja en mallbild.", "error");
          alert("Välj en mallbild först.");
          return;
        }

        const qrFiles = qrInput.files;
        if (!qrFiles || qrFiles.length === 0) {
          setStatus("Du måste välja minst en QR-kodfil.", "error");
          alert("Välj minst en QR-kodbild innan du genererar PDF.");
          return;
        }

        // Hämta parametrar
        const qrOffsetXmm = parseFloat(qrOffsetXInput.value) || 0;
        const qrOffsetYmm = parseFloat(qrOffsetYInput.value) || 0;
        const qrSizemm   = parseFloat(qrSizeInput.value)   || 20;

        generateBtn.disabled = true;
        setStatus("Läser in mallbild och QR-koder...", "info");

        try {
          // Läs mallbilden
          const templateFile = templateInput.files[0];
          const templateDataUrl = await readFileAsDataURL(templateFile);
          const templateSize = await getImageSize(templateDataUrl);
          const templateRatio = templateSize.height / templateSize.width; // h/w

          // Läs QR-bilder
          const qrImages = await loadQrImages(qrFiles);
          if (qrImages.length === 0) {
            setStatus("Hittade inga giltiga QR-bildfiler.", "error");
            generateBtn.disabled = false;
            return;
          }

          setStatus("Genererar PDF...", "info");

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({
            orientation: "portrait",
            unit: "mm",
            format: "a4"
          });

          const pageWidth = doc.internal.pageSize.getWidth();   // 210 mm
          const pageHeight = doc.internal.pageSize.getHeight(); // 297 mm

          const margin = 10;
          const columns = 2;
          const rows = 3;
          const cellWidth = (pageWidth - margin * 2) / columns;
          const cellHeight = (pageHeight - margin * 2) / rows;

          // Loopa över alla QR-koder, generera en biljett per QR
          qrImages.forEach((qr, index) => {
            const ticketsPerPage = columns * rows; // 6
            const positionInPage = index % ticketsPerPage;
            const row = Math.floor(positionInPage / columns);
            const col = positionInPage % columns;

            if (index > 0 && positionInPage === 0) {
              doc.addPage();
            }

            const cellX = margin + col * cellWidth;
            const cellY = margin + row * cellHeight;

            // Rita en svag ram runt biljetten (frivilligt – kan kommenteras bort)
            doc.setDrawColor(220);
            doc.setLineWidth(0.2);
            doc.rect(cellX, cellY, cellWidth, cellHeight);

            // Beräkna mallbildens storlek i cellen (behåll proportioner, "contain")
            const cellAspect = cellWidth / cellHeight;
            const imgAspect = 1 / templateRatio; // w/h
            let drawWidth, drawHeight;

            if (imgAspect > cellAspect) {
              // Bilden är "bredare" än cellen → begränsa på bredd
              drawWidth = cellWidth;
              drawHeight = drawWidth * templateRatio;
            } else {
              // Bilden är "högre" → begränsa på höjd
              drawHeight = cellHeight;
              drawWidth = drawHeight / templateRatio;
            }

            const imgX = cellX + (cellWidth - drawWidth) / 2;
            const imgY = cellY + (cellHeight - drawHeight) / 2;

            // Rita mallbilden
            doc.addImage(
              templateDataUrl,
              "PNG",
              imgX,
              imgY,
              drawWidth,
              drawHeight
            );

            // QR-position: relativt mallbildens övre vänstra hörn (i mm)
            const qrX = imgX + qrOffsetXmm;
            const qrY = imgY + qrOffsetYmm;

            // Rita QR-bilden (kvadrat)
            doc.addImage(
              qr.dataUrl,
              "PNG",
              qrX,
              qrY,
              qrSizemm,
              qrSizemm
            );
          });

          const fileName = "biljetter_mall_qr.pdf";
          doc.save(fileName);
          setStatus("Klar! PDF nedladdad: " + fileName, "ok");
          alert("PDF genererad och nedladdad: " + fileName);
        } catch (err) {
          console.error(err);
          setStatus("Något gick fel vid generering av PDF: " + err.message, "error");
          alert("Fel vid generering av PDF: " + err.message);
        } finally {
          generateBtn.disabled = false;
        }
      }

      generateBtn.addEventListener("click", () => {
        setStatus("Startar generering...", "info");
        generatePdf();
      });

      setStatus("Redo. Välj mallbild + QR-koder och klicka på \"Generera PDF\".", "info");
    });
  </script>
</body>
</html>
